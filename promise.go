package Q

import (
//"reflect"
)

type Promised struct {
	invokable
}

///////////////////////////////////////////////////////////////////////////////////////
// makePromise
///////////////////////////////////////////////////////////////////////////////////////
func makePromised() *Promised {
	pr := new(Promised)
	pr.pf = make(ParamFuture)
	pr.rf = make(ResultFuture)

	return pr
}

///////////////////////////////////////////////////////////////////////////////////////
// Promise Then
///////////////////////////////////////////////////////////////////////////////////////
func (p *Promised) Then(init ...interface{}) *Promised {
	newP := makePromised()

	go func() {
		// old error from prev promises
		if p.err != nil {
			newP.sendError(nil, 0, p.err.Error())
			return
		}

		// wait on result from prev promise
		in := p.ReceiveWithIndex()
		// and invoke it
		targets := toValueArray(init)
		newP.invokeTargets(targets, in)
	}()

	return newP
}

///////////////////////////////////////////////////////////////////////////////////////
// Done
///////////////////////////////////////////////////////////////////////////////////////
func (p *Promised) Done() ([]interface{}, error) {

	out := p.ReceiveWithIndex()
	res := fromValueArray(out)
	return res, p.err
}

///////////////////////////////////////////////////////////////////////////////////////
// Finally
///////////////////////////////////////////////////////////////////////////////////////
func (p *Promised) Finally(init interface{}) error {

	if p.err != nil {
		return p.err
	}

	in := p.ReceiveWithIndex()
	//TODO change that, use other toValueArray version
	vals := make([]interface{}, 1)
	vals[0] = init

	targets := toValueArray(vals)
	go p.invokeTargets(targets, in)
	return nil
}

///////////////////////////////////////////////////////////////////////////////////////
// Promise
///////////////////////////////////////////////////////////////////////////////////////
func Promise(init ...interface{}) *Promised {

	pr := makePromised()
	targets := toValueArray(init)
	go pr.invokeTargets(targets, nil)
	return pr
}
